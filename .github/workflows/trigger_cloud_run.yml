name: Trigger Titanic Agent on Cloud Run

on:
  schedule:
    # 毎日午前0時に実行 (UTC)
    - cron: "0 0 * * *"
  workflow_dispatch:  # 手動実行も可能

jobs:
  trigger-cloud-run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # GCP 認証 (Workload Identity Federation)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: "projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider"
          service_account: "github-trigger-invoker@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Trigger Cloud Run Service
        run: |
          gcloud run jobs execute ${{ secrets.GCP_CLOUD_RUN_JOB_NAME }} --region=asia-northeast1 --project=${{ secrets.GCP_PROJECT_ID }}
