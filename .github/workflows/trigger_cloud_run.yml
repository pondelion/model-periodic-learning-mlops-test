name: Trigger Titanic Agent on Cloud Run

on:
  schedule:
    # 毎日 0, 6, 12, 18 時に実行 (UTC)
    - cron: "0 0,6,12,18 * * *"
  workflow_dispatch:  # 手動実行も可能

jobs:
  trigger-cloud-run:
    if: ${{ vars.SKIP_SCHEDULED_RUN != 'true' }}
    runs-on: ubuntu-latest
    # Add "id-token" with the intended permissions.
    permissions:
      contents: 'read'
      id-token: 'write'
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # GCP 認証 (Workload Identity Federation)
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: "projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ secrets.GCP_WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ secrets.GCP_GITHUB_PROVIDER }}"
          service_account: "github-trigger-invoker@${{ secrets.GCP_PROJECT_ID }}.iam.gserviceaccount.com"

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Trigger Cloud Run Service
        run: |
          gcloud run jobs execute ${{ secrets.GCP_CLOUD_RUN_JOB_NAME }} --region=asia-northeast1 --project=${{ secrets.GCP_PROJECT_ID }}
